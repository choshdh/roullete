
    
    <!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="data:," />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>룰렛</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f9f9f9;
            font-family: Arial, sans-serif;
            /* 스크롤 완전 차단 */
            overflow: hidden;
        }

        .title {
            margin-top: 35px;
            font-size: 50px;
            font-weight: bold;
            text-align: center;
        }

        .main-container {
            display: flex;
            justify-content: center; /* 수평 가운데 정렬 */
            align-items: flex-start;
            gap: 20px;
            margin-top: 50px;
            margin-left: 300px; /* 채팅 컨테이너 공간을 고려 */
            width: calc(100% - 300px); /* 채팅 컨테이너를 제외한 나머지 공간 사용 */
        }

        .wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        canvas {
            border: 5px solid #333;
            border-radius: 50%;
            width: 600px;
            height: 600px;
        }

        .pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 20px solid red;
            z-index: 2;
        }

        .legends-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .legend {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }



        /* 폭죽 효과 시작 */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 상호작용 차단 */
            z-index: 10;
        }

        .firework {
            position: absolute;
            width: 1px;
            height: 1px;
            background-color: #ff0;
            border-radius: 50%;
            animation: explode 1.5s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: scale(0); /* 크기가 0에서 시작 */
                opacity: 1; /* 완전히 보이는 상태 */
            }

            50% {
                transform: scale(10); /* 중간 크기로 확장 */
                opacity: 1; /* 여전히 보임 */
            }

            100% {
                transform: scale(25); /* 최종 크기로 확장 */
                opacity: 0; /* 사라짐 */
            }
        }

        #winner-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 20px 40px;
            border-radius: 10px;
            text-align: center;
            font-size: 2em;
            z-index: 20;
            animation: fadeIn 0.5s ease;
        }

        .hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
        /* 폭죽 효과 끝 */


        /* 스포트라이트 시작 */
        .spotlight {
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.8) 0%, rgba(255,255,255,0) 70%);
            pointer-events: none;
        }
        /* 스포트라이트 끝 */


        /* 추첨 사운드 시작 */
        #drumroll-sound {
            display: none;
        }
        /* 추첨 사운드 끝 */

        /* 팝업 스타일 */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            z-index: 100;
            display: none;
        }

        .popup textarea {
            width: 800px;
            height: 200px;
            margin-bottom: 10px;
        }

        .popup button {
            margin-right: 10px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        /* 세그먼트 */
        #segmentFields {
            max-height: 300px; /* 최대 높이 설정 */
            overflow-y: auto; /* 스크롤 활성화 */
            margin-bottom: 10px;
        }

        .segment-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px; /* 세로 간격 줄임 */
        }

        .segment-row label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .segment-row button.deleteRowButton {
            background-color: red;
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 21px;
            margin: 0px;
            padding: 0px;
            cursor: pointer;
        }

        .segment-row button.deleteRowButton:hover {
            background-color: darkred;
        }


        /* 채팅 */
        .chat-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background-color: #f1f1f1;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background-color: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #fff;
        }

        .chat-messages .message {
            margin-bottom: 10px;
        }

        .chat-messages .message .user {
            font-weight: bold;
            margin-right: 5px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
        }

        .chat-input textarea {
            width: 100%; /* 가로 크기를 부모 컨테이너에 맞춤 */
            height: 100px; /* 기본 높이 설정 */
            max-width: 100%; /* 최대 가로 크기 제한 */
            min-height: 50px; /* 최소 높이 제한 */
            resize: vertical; /* 세로 크기만 조정 가능 (가로 크기 고정) */
            overflow-y: auto; /* 텍스트가 많을 경우 스크롤 추가 */
            word-wrap: break-word; /* 줄바꿈 활성화 */
            white-space: pre-wrap; /* 텍스트 줄바꿈 유지 */
            font-family: Arial, sans-serif; /* 폰트 설정 */
            font-size: 14px; /* 가독성을 위한 글자 크기 */
            padding: 10px; /* 내부 여백 */
            border: 1px solid #ccc; /* 테두리 */
            border-radius: 4px; /* 모서리 둥글게 */
            box-sizing: border-box; /* 패딩 포함 크기 계산 */
        }

        .chat-input button {
            margin-left: 10px;
            margin-top: 0px;
            padding: 5px 10px;
            border: none;
            background-color: #333;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            height:100%
        }

        .chat-input button:hover {
            background-color: #555;
        }

    </style>
    <audio id="drumroll-sound" preload="auto" controls>
        <source src="https://files.catbox.moe/0e7cb7.wav">
    </audio>
</head>
<body>


    <div class="chat-container">
        <div class="chat-header">
            <div style="display: flex; align-items: center;">
                <label for="nickname" style="margin-right: 10px; color: white;">채팅</label>
                <input type="hidden" id="nickname_hidden" style="flex: 1; padding: 5px;" />
                <input type="text" id="nickname" placeholder="닉네임 입력" style="flex: 1; padding: 5px;" />
                <button id="applyNicknameButton" style="margin-left:10px; margin-top:0px; width:40px; height:29px; padding:0px;">적용</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <textarea id="chatInput" placeholder="메시지를 입력하세요..."></textarea>
            <button id="sendButton">전송</button>
        </div>
    </div>

    <div class="title">
        <img src="https://i.imgur.com/SQRpzYy.png" style="height: 120px; vertical-align: middle;">
    </div>
    <div class="main-container">
        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheel" width="600" height="600"></canvas>
            <div>
                <button id="configButton">리스트 편집</button>
                <button id="wheelButton">돌리기</button>
            </div>
        </div>
        <div class="legends-container" id="legends-container"></div>
    </div>






    <div class="fireworks-container"></div>
    <div id="winner-message" class="hidden">
        <h1 id="winner-name"></h1>
    </div>

    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="popup" id="popup">
        <h3>돌림판 리스트 편집</h3>
        <div id="segmentFields"></div>
        <div>
            <button id="clearSegments">전체 삭제</button>
            <button id="saveSegments">저장</button>
            <button id="closePopup">닫기</button>
        </div>
    </div>
    <!-- <div class="spotlight" id="spotlight"></div> -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, onChildChanged, update, onChildAdded, query, limitToLast, push, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = (Math.random() * 16) | 0;
                const v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        }

        function initializeUUID() {
            let uuid = localStorage.getItem('userUUID'); // LocalStorage에서 UUID 가져오기
            if (!uuid) {
                uuid = generateUUID(); // UUID 생성
                localStorage.setItem('userUUID', uuid); // LocalStorage에 저장
            }
            return uuid;
        }

        window.clientId = initializeUUID();

        document.getElementById("wheelButton").addEventListener("click", () => {
            spinWheel(false, window.clientId);
        });

        const firebaseConfig = {
            apiKey: "AIzaSyClZ3NDMZsB1Bkif4_EvtGCyQhVJ2lLOSQ",
            databaseURL: "https://narang-lol-za-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "narang-lol-za"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const rouletteRef = ref(db, "roulette");

        window.currentSpinning = false; //재접속 체크용
        onValue(rouletteRef, (snapshot) => {
            const data = snapshot.val();

            if (data) {
                var db_isSpinning = data.isSpinning || false;
                var db_rotation = data._rotation || false;
                var db_clientId = data.clientId || -1;

                if (db_isSpinning == true) {
                    document.getElementById("configButton").disabled = true;
                    document.getElementById("wheelButton").disabled = true;
                } else {
                    document.getElementById("configButton").disabled = false;
                    document.getElementById("wheelButton").disabled = false;
                }

                if ((db_isSpinning != false && db_rotation != false && db_clientId != -1)) {
                    if (window.clientId != db_clientId) {
                        spinWheel(db_rotation, db_clientId);
                    } else if (!window.currentSpinning) { //재접속 한거라면
                        spinWheel(db_rotation, db_clientId, true);
                    }
                }

            }

        });


        //무료 사운드 확인
        //https://pixabay.com/

        //무료 이미지 업로드 및 다운로드 링크 지원
        //https://imgur.com/

        //무료 음성 파일 올리기 및 다운로드 링크 지원
        //https://catbox.moe/


        const colors = [
            "#CD0404", "#EE0000", "#F23B3B", "#F56666", "#F89999", "#FCCCCC",
            "#D53209", "#FF4500", "#FF6A33", "#FF8F66", "#FFB599", "#FFDACC",
            "#D36942", "#FE8052", "#FE9975", "#FEB397", "#FFCCBA", "#FFE6DC",
            "#D6AB00", "#FFD400", "#FFDD33", "#FFE566", "#FFEE99", "#FFF6CC",
            "#8EDD13", "#A1F524", "#BCF95D", "#CEFE83", "#DEFFAB", "#EEFED6",
            "#1FAD1F", "#32CD32", "#5BD75B", "#84E184", "#ADEBAD", "#D6F5D6",
            "#03C4C4", "#15DFDF", "#3BEDED", "#6DF2F2", "#9DF6F6", "#CEFBFB",
            "#163ECA", "#1C4EFC", "#4971FD", "#7795FD", "#A4B8FE", "#D2DCFE",
            "#1C2582", "#232EA3", "#4F58B5", "#7B82C8", "#A7ABDA", "#D3D5ED",
            "#471293", "#5917B8", "#7A45C6", "#9B74D4", "#BDA2E3", "#DED1F1",
            "#CC1076", "#FF1493", "#FD51AD", "#FF72BE", "#FFA1D4", "#FFD0E9",
            "#94070D", "#B90910", "#C73A40", "#D56B70", "#E39D9F", "#F1CECF",
            "#862E1D", "#A83A24", "#B96150", "#CB897C", "#DCB0A7", "#EED8D3",
            "#804106", "#A05107", "#B37439", "#C6976A", "#D9B99C", "#ECDCCD",
            "#7A7A00", "#999900", "#ADAD33", "#C2C266", "#D6D699", "#EBEBCC",
            "#006600", "#008000", "#339933", "#66B366", "#99CC99", "#CCE6CC",
            "#097C7C", "#0B9B9B", "#3CAFAF", "#6DC3C3", "#9DD7D7", "#CEEBEB",
            "#1F9AC6", "#27C1F8", "#52CDF9", "#7DDAFB", "#A9E6FC", "#D4F3FE",
            "#0056AA", "#0074E5", "#1E90FF", "#56ACFF", "#8FC8FF", "#C7E3FF",
            "#560066", "#6B0080", "#893399", "#A666B3", "#C499CC", "#E1CCE6",
            "#B214B2", "#DF19DF", "#E547E5", "#EC75EC", "#F2A3F2", "#F9D1F9"
        ];


		window.segments = JSON.parse('[["고영화 DK ShowMaker",5],["박환진 경로우대",20],["성주현 노곤",10],["이정우 DK BeryL",2],["이준석 DK Nuguri",4],["구새얀 얀진이네",10],["홍석범 엉덩이빵빵빵",11],["최태욱 불태우기",1],["박주환 주 환",3],["정준혁 쫄직",8],["조승현 abrasax",20],["박지윤 메롱시티주민",4],["박진원 말차초코스무디",1],["황운석 운스",2],["황인호 이로리노",20],["김준호 Allsboy",5],["여소현 에잇 기분이다",12],["김현기 충북1등 김현기",2],["강현구 하마인형",2],["채지훈 찰떡말이",1],["다인 굴갈비",5],["전형집 예람들",2]]');
		const segmentsRef = ref(db, "segments");
		onValue(segmentsRef, (snapshot) => {
            const data = snapshot.val();

            if (data) {
                window.segments = JSON.parse(data);
				window.createWheel();
				document.getElementById("weekTitle").innerText = "커스텀 리스트"
            }
        });



        let currentRotation = 0;
        let spinAnimationFrame = null;

        window.save__ = async (obj, callback) => {
            await set(rouletteRef, obj).then(() => {
                callback && callback();
            }).catch((error) => {
                console.error("firebase error : ", error);
            });
        }

        window.createWheel = () => {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const legendsContainer = document.getElementById('legends-container');

            const totalWeight = window.segments.reduce((acc, [, weight]) => acc + weight, 0);
            let startAngle = 0;

            // Clear legend container
            legendsContainer.innerHTML = '';
            let legendGroup;

            window.segments.forEach(([name, weight], index) => {
                const segmentAngle = (weight / totalWeight) * 2 * Math.PI;
                const color = colors[Math.floor(colors.length / window.segments.length) * index];

                // Draw segment
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2, canvas.height / 2);
                ctx.arc(
                    canvas.width / 2,
                    canvas.height / 2,
                    canvas.width / 2,
                    startAngle,
                    startAngle + segmentAngle
                );
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.stroke();

                startAngle += segmentAngle;

                // Create legend group every 20 items
                if (index % 20 === 0) {
                    legendGroup = document.createElement('div');
                    legendGroup.className = 'legend';
                    legendsContainer.appendChild(legendGroup);
                }

                if (index == 0) {
                    const weekItem = document.createElement('div');
                    weekItem.id = "weekTitle"
                    weekItem.className = 'legend-item';
                    weekItem.innerText = '20250519 ~ 20250525'
                    legendGroup.appendChild(weekItem);
                }

                // Create legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                colorBox.style.background = color;

                const text = document.createElement('span');
                text.innerText = `${name} (${weight})`;

                legendItem.appendChild(colorBox);
                legendItem.appendChild(text);
                legendGroup.appendChild(legendItem);
            });
        }

        window.spinWheel = (__rotation, cId, isReconnect) => {

            var exec = (___rotation, cId, isReconnect) => {
                currentRotation = 0;

                const messageContainer = document.getElementById('winner-message');
                if (!messageContainer.classList.contains('hidden')) {
                    messageContainer.classList.add('hidden');
                }

                stopFireworksLoop();
                const fireworks = document.getElementsByClassName('firework')
                while (fireworks.length > 0) { // HTMLCollection은 실시간으로 업데이트되므로 while 루프 사용
                    fireworks[0].remove(); // 첫 번째 요소를 계속 삭제
                }


                const audio = document.getElementById('drumroll-sound');
                audio.pause();
                audio.currentTime = 0;
                audio.play().catch((error) => {
                    console.error('오디오 재생 중 오류 발생:', error);
                });


                if (spinAnimationFrame) {
                    cancelAnimationFrame(spinAnimationFrame);
                }

                const canvas = document.getElementById('wheel');
                const totalRotation = ___rotation == false ? Math.random() * 360 + 3600 : ___rotation;

                !isReconnect && ___rotation == false && save__({ isSpinning: true, _rotation: totalRotation, clientId: cId });

                const duration = 10500;
                const startTime = performance.now();
                let isHalfSecondEventTriggered = false; // 0.5초 전 이벤트 트리거 여부

                function animateSpin(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easing = 1 - Math.pow(1 - progress, 3);
                    const rotation = currentRotation + easing * totalRotation;

                    canvas.style.transform = `rotate(${rotation}deg)`;

                    // 세로 높이 변화 계산
                    const normalizedRotation = rotation % 360; // 0 ~ 360도로 정규화
                    const heightFactor = Math.abs(Math.sin(normalizedRotation * (Math.PI / 180))); // 세로 높이 변화 비율 (0 ~ 1)

                    // 흔들림 효과
                    // 0.5초 전 이벤트 처리
                    const mainContainer = document.getElementsByClassName("main-container")[0];
                    if (!isHalfSecondEventTriggered && elapsed >= duration - 500) {
                        isHalfSecondEventTriggered = true;
                        mainContainer.style.transition = 'transform 0.5s ease-out'; // 부드러운 이동
                        mainContainer.style.transform = 'translateX(0)'; // 흔들림 초기화
                    } else {
                        const shakeIntensity = 35 * heightFactor; // 진폭 크기 조정
                        mainContainer.style.transition = ''; // 부드러운 이동 초기화
                        mainContainer.style.transform = `translateX(${shakeIntensity}px)`; // 흔들림 효과 적용
                    }

                    if (progress < 1) {
                        spinAnimationFrame = requestAnimationFrame(animateSpin);

                    } else {
                        currentRotation += totalRotation % 360;

                        calculateResult(currentRotation, ___rotation, cId);
                    }
                }

                spinAnimationFrame = requestAnimationFrame(animateSpin);

            }

            if (window.clientId != cId) {
                console.log("남이 돌림")
                exec(__rotation, cId);
            } else {
                console.log("내가 돌림")

                if (isReconnect) {
                    exec(__rotation, cId, isReconnect);
                } else {
                    window.currentSpinning = true;
                    save__({ isSpinning: true, _rotation: false, clientId: cId }, () => { exec(__rotation, cId) });
                }

            }

        }

        window.calculateResult = (finalRotation, ___rotation, cId) => {
            const normalizedRotation = (360 - (finalRotation % 360) + 270) % 360;

            const totalWeight = window.segments.reduce((acc, [, weight]) => acc + weight, 0);
            let currentAngle = 0;

            for (const [name, weight] of window.segments) {
                const segmentAngle = (weight / totalWeight) * 360;
                if (normalizedRotation >= currentAngle && normalizedRotation < currentAngle + segmentAngle) {
                    setTimeout(function () {
                        showWinner(name, ___rotation, cId); // 당첨자 표시
                        startFireworksLoop(); // 폭죽 효과
                    }, 50)
                    return;
                }
                currentAngle += segmentAngle;
            }
        }

        window.showWinner = (name, ___rotation, cId) => {

            const messageContainer = document.getElementById('winner-message');
            const winnerName = document.getElementById('winner-name');
            winnerName.innerHTML = `축하합니다!<br>당첨자는 ${name}님입니다!`;
            messageContainer.classList.remove('hidden');

            messageContainer.onclick = function () {
                messageContainer.classList.add('hidden');
            }

            if (window.clientId == cId) {
                save__({ isSpinning: false, _rotation: false, clientId: -1 });
                window.currentSpinning = false;
            }

        }

        window.startFireworks = () => {
            const container = document.querySelector('.fireworks-container');

            // 폭죽 생성
            for (let i = 0; i < 250; i++) {
                const firework = document.createElement('div');
                firework.classList.add('firework');
                firework.style.left = `${Math.random() * 100}%`;
                firework.style.top = `${Math.random() * 100}%`;
                firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                firework.style.animationDelay = `${Math.random() * 1.5}s`;
                firework.style.animationDuration = `2s`;
                container.appendChild(firework);

                // 폭죽 삭제
                setTimeout(() => {
                    firework.remove();
                }, 3500);
            }
        }

        let fireworksInterval;
        window.startFireworksLoop = () => {
            startFireworks(); // 즉시 시작
            fireworksInterval = setInterval(startFireworks, 2000); // 2.5초마다 실행
        }

        window.stopFireworksLoop = () => {
            if (fireworksInterval) {
                clearInterval(fireworksInterval);
                fireworksInterval = null;
            }
        }

        window.moveSpotlight = () => {
            const spotlight = document.getElementById('spotlight');
            let x = Math.random() * window.innerWidth;
            let y = Math.random() * window.innerHeight;

            spotlight.style.transition = 'top 1s ease, left 1s ease';
            spotlight.style.left = `${x}px`;
            spotlight.style.top = `${y}px`;

            setTimeout(moveSpotlight, 1000);
        }

        createWheel();





        //커스텀 리스트 편집 구현 ------------------------------------------------------------------------------------------
        document.getElementById("configButton").addEventListener("click", () => {
            const popup = document.getElementById("popup");
            const overlay = document.getElementById("popupOverlay");
            const segmentFields = document.getElementById("segmentFields");

            // 기존 세그먼트를 입력 필드로 표시
            segmentFields.innerHTML = "";
            window.segments.forEach(([text, value], index) => {
                const fieldDiv = document.createElement("div");
                fieldDiv.classList.add("segment-row");
                fieldDiv.innerHTML = `
                    <label>문자: <input type="text" class="segmentText" value="${text}" /></label>
                    <label>값: <input type="number" class="segmentValue" value="${value}" step="1" /></label>
                    <button class="deleteRowButton" data-index="${index}">X</button>
                `;
                segmentFields.appendChild(fieldDiv);
            });

            // 비어 있는 행 추가 (항상 하나는 추가됨)
            addEmptySegmentRow();

            // 팝업 열기
            popup.style.display = "block";
            overlay.style.display = "block";
        });

        function addEmptySegmentRow() {
            const segmentFields = document.getElementById("segmentFields");
            const emptyRowCount = Array.from(segmentFields.children).filter(row => {
                const textInput = row.querySelector(".segmentText").value.trim();
                const valueInput = row.querySelector(".segmentValue").value.trim();
                return textInput === "" && valueInput === "";
            }).length;

            // 빈 줄이 1개 미만일 경우 추가
            if (emptyRowCount < 1) {
                const fieldDiv = document.createElement("div");
                fieldDiv.classList.add("segment-row");
                fieldDiv.innerHTML = `
                    <label>문자: <input type="text" class="segmentText" /></label>
                    <label>값: <input type="number" class="segmentValue" step="1"/></label>
                    <button class="deleteRowButton">X</button>
                `;
                segmentFields.appendChild(fieldDiv);
            }
        }

        document.getElementById("segmentFields").addEventListener("input", (event) => {
            if (event.target.classList.contains("segmentValue")) {
                const input = event.target;
                const cursorPosition = input.selectionStart; // 현재 커서 위치 저장

                // 숫자가 아닌 문자를 필터링
                const filteredValue = input.value.replace(/[^0-9]/g, "");

                if (input.value !== filteredValue) {
                    input.value = filteredValue; // 필터링된 값 적용
                    input.setSelectionRange(cursorPosition - 1, cursorPosition - 1); // 커서 위치 복원
                }
            }

            const segmentFields = document.getElementById("segmentFields");

            // 빈 줄이 항상 하나만 남도록 유지
            addEmptySegmentRow();

            // 모든 필드 검사 후 비어있는 줄이 2개를 초과할 경우 제거
            const rows = Array.from(segmentFields.children);
            const emptyRows = rows.filter(row => {
                const textInput = row.querySelector(".segmentText").value.trim();
                const valueInput = row.querySelector(".segmentValue").value.trim();
                return textInput === "" && valueInput === "";
            });

            while (emptyRows.length > 1) {
                const rowToRemove = emptyRows.pop();
                rowToRemove.remove();
            }
        });

        document.getElementById("segmentFields").addEventListener("click", (event) => {
            if (event.target.classList.contains("deleteRowButton")) {
                const row = event.target.closest(".segment-row");
                row.remove();

                // 빈 줄 유지
                addEmptySegmentRow();
            }
        });

        document.getElementById("clearSegments").addEventListener("click", () => {
            const segmentFields = document.getElementById("segmentFields");

            // 모든 segment-row 삭제
            segmentFields.innerHTML = "";

            // 비어 있는 행 하나 추가
            addEmptySegmentRow();
        });

        document.getElementById("saveSegments").addEventListener("click", async() => {
            const segmentFields = document.getElementById("segmentFields");
            const rows = Array.from(segmentFields.children);
            const newSegments = [];

            rows.forEach(row => {
                const text = row.querySelector(".segmentText").value.trim();
                const value = parseInt(row.querySelector(".segmentValue").value, 10);

                if (text && !isNaN(value)) {
                    newSegments.push([text, value]);
                }
            });

            if (newSegments.length > 0) {
                window.segments = newSegments;
				await set(segmentsRef, JSON.stringify(newSegments));
                createWheel();
                document.getElementById("weekTitle").innerText = "커스텀 리스트"
                document.getElementById("closePopup").click();
            } else {
                alert("유효한 데이터를 입력하세요.");
            }
        });

        // 텝 이동
        document.getElementById("segmentFields").addEventListener("keydown", (event) => {
            if (event.key === "Tab") {
                const inputs = Array.from(document.querySelectorAll(".segmentText, .segmentValue")); // 모든 입력 필드
                const currentIndex = inputs.indexOf(event.target);

                if (currentIndex !== -1) {
                    event.preventDefault(); // 기본 Tab 동작 방지
                    const nextIndex = (currentIndex + 1) % inputs.length; // 다음 필드로 이동
                    inputs[nextIndex].focus(); // 포커스 이동
                }
            }
        });

        // 팝업 닫기 버튼
        document.getElementById("closePopup").addEventListener("click", () => {
            const popup = document.getElementById("popup");
            const overlay = document.getElementById("popupOverlay");
            popup.style.display = "none";
            overlay.style.display = "none";
        });





















        //채팅 구현-------------------------------------------------------------------
        const chatRef = ref(db, "chat");
        const limitedChatRef = query(chatRef, limitToLast(100));

        // 닉네임 입력 필드와 메시지 전송 버튼 가져오기
        const nicknameInput = document.getElementById("nickname");
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendButton");
        const chatMessages = document.getElementById("chatMessages");

        // 초기 데이터 한 번에 로드
        get(limitedChatRef).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                for (const key in data) {
                    const message = data[key];
                    const nickname = message.nickname || "알 수 없음";
                    const text = message.message;

                    const messageElement = document.createElement("div");
                    messageElement.style.marginBottom = "10px";
                    messageElement.textContent = `${nickname}: ${text}`;
                    chatMessages.appendChild(messageElement);
                }
                // 스크롤 항상 아래로
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }).catch((error) => {
            console.error("초기 데이터 로드 실패:", error);
        });

        // 새로 추가되는 메시지 처리
        onChildAdded(limitedChatRef, (snapshot) => {
            const data = snapshot.val();
            const nickname = data.nickname || "알 수 없음";
            const message = data.message;

            const messageElement = document.createElement("div");
            messageElement.style.marginBottom = "10px";
            messageElement.textContent = `${nickname}: ${message}`;
            chatMessages.appendChild(messageElement);

            // 스크롤 항상 아래로
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // 메시지 입력 필드에서 Enter 키로 전송
        chatInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        // 메시지 전송 버튼 클릭으로 전송
        sendButton.addEventListener("click", sendMessage);

        // 메시지 전송 함수
        function sendMessage() {
            const nickname = nicknameInput.value.trim();
            const chat = chatInput.value.trim();

            if (chat == "reset") {
                window.clear();
                chatInput.value = "";
                return;
            }

            if (!nickname) {
                alert("닉네임을 입력해야 메시지를 보낼 수 있습니다!");
                return;
            }

            if (!chat) {
                alert("메시지를 입력하세요!");
                return;
            }

            // 메시지 전송
            const messageRef = push(chatRef);
            set(messageRef, {
                nickname: nickname,
                message: chat,
                timestamp: Date.now(),
            })
                .then(() => console.log("메시지 전송 성공"))
                .catch((error) => console.error("메시지 전송 실패:", error));

            // 입력 필드 초기화
            chatInput.value = "";
        }


        const applyNicknameButton = document.getElementById("applyNicknameButton");
        applyNicknameButton.addEventListener("click", async () => {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                alert("닉네임을 입력하세요!");
                return;
            }
            await checkAndSaveNickname(nickname);
        });

        //닉네임 관련
        const nicknamesRef = ref(db, "nicknames");
        // 닉네임 중복 확인 함수
        async function checkAndSaveNickname(nickname) {
            const snapshot = await get(nicknamesRef);

            if (snapshot.exists()) {
                const nicknames = snapshot.val();

                if (Object.values(nicknames).includes(nickname)) {
                    alert("이미 사용중인 닉네임.");
                    return false;
                }
            }

            // 닉네임 저장
            const newNicknameRef = push(nicknamesRef);
            await set(newNicknameRef, nickname);

            // 닉네임 저장 완료 시 UI 업데이트
            nicknameInput.value = nickname;
            nicknameInput.disabled = true;

            saveNicknameLocally(nickname);
            applyNicknameButton.style.display = "none";

            return true;
        }

        function saveNicknameLocally(nickname) {
            const now = new Date();
            const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0); // 오늘 자정
            const expiration = midnight.getTime(); // 자정의 타임스탬프

            const nicknameData = {
                storedNickname: nickname,
                expiresAt: expiration,
            };

            localStorage.setItem("nickname", JSON.stringify(nicknameData)); // 로컬 저장소에 닉네임 저장
        }

        // 닉네임 입력 필드에서 Enter 키로 닉네임 저장
        nicknameInput.addEventListener("keydown", async (event) => {
            if (event.key === "Enter") {
                const nickname = nicknameInput.value.trim();
                if (!nickname) {
                    alert("닉네임을 입력하세요!");
                    return;
                }
                await checkAndSaveNickname(nickname);
            }
        });


        function loadNickname() {
            const nicknameData = localStorage.getItem("nickname");

            if (nicknameData) {
                const { storedNickname, expiresAt } = JSON.parse(nicknameData);
                const now = Date.now();

                if (now < expiresAt) {
                    console.log("닉네임이 유효합니다:", storedNickname);

                    if (storedNickname) {
                        nicknameInput.value = storedNickname;
                        nicknameInput.disabled = true; // 닉네임 입력 비활성화
                        applyNicknameButton.style.display = "none";
                    }
                } else {
                    console.log("닉네임이 만료되었습니다.");
                    localStorage.removeItem("nickname"); // 만료된 데이터 삭제
                }
            }

        }








        // 닉네임, 채팅 리셋
        const lastResetDateRef = ref(db, "lastResetDate");
        // 오늘 날짜 가져오기
        function getCurrentDate() {
            return new Date().toISOString().split("T")[0]; // YYYY-MM-DD 형식
        }

        // 데이터 초기화 함수
        async function resetData() {
            try {
                await remove(nicknamesRef); // 닉네임 데이터 삭제
                console.log("닉네임 데이터 삭제")
                await remove(chatRef);     // 채팅 데이터 삭제
                console.log("채팅 데이터 삭제")

                console.log("데이터 초기화 완료");
            } catch (error) {
                console.error("데이터 초기화 중 오류 발생:", error);
            }
        }

        // 날짜 확인 및 처리
        async function checkAndResetData() {
            try {
                const currentDate = getCurrentDate();
                const snapshot = await get(lastResetDateRef);

                if (!snapshot.exists()) {
                    // Firebase에 날짜가 없으면 오늘 날짜 저장
                    await set(lastResetDateRef, currentDate);
                    console.log("초기 날짜가 설정되었습니다:", currentDate);
                } else {
                    const lastResetDate = snapshot.val();

                    if (lastResetDate !== currentDate) {
                        // 날짜가 다르면 데이터 초기화 후 새로운 날짜 저장
                        console.log("하루가 지났습니다. 데이터를 초기화합니다.");
                        await resetData();
                        await set(lastResetDateRef, currentDate);
                        console.log("새로운 날짜로 업데이트되었습니다:", currentDate);
                    } else {
                        console.log("오늘 이미 초기화되었습니다. 작업을 건너뜁니다.");
                    }
                }
            } catch (error) {
                console.error("날짜 확인 중 오류 발생:", error);
            }
        }

        // 페이지 로드 시 실행
        document.addEventListener("DOMContentLoaded", () => {
            checkAndResetData();
            loadNickname();
        });



        const resetRef = ref(db, "reset");
        window.clear = async () => {
            localStorage.removeItem("nickname");
            resetData();
            save__({ isSpinning: false, _rotation: false, clientId: -1 });
            await set(resetRef, "Y");
			await set(segmentsRef, "");
        }

        onValue(resetRef, async (snapshot) => {
            const data = snapshot.val();

            if (data) {

                if (data == "Y") {
                    localStorage.removeItem("nickname");
                    await set(resetRef, "N");
                    window.location.reload();
                }
                
            }

        })

        //moveSpotlight();
    </script>
</body>
</html>

  
  
  

  
  
  